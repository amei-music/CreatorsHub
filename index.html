<html>
<head>
  <meta charset="UTF-8">
  <title>FM_MW1</title>
  <style type="text/css">
  <!--
  table, td, th {
    border: solid 1px #999999;
  }

  div#msg {
    overflow: scroll;   /* スクロール表示 */
    width: 600px;
    height: 400px;
    border: solid 1px #999999;
  }
  //-->
  </style>

  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">
    "use strict";

    // 動的な表示コントロール
    var view = {
      filter: {}, // メッセージをフィルタする

      filterSet : function(cbox){
        if (cbox.checked) this.filter[cbox.value] = true;
        else delete this.filter[cbox.value];

        console.log(cbox, cbox.checked, this.filter);
      },
    };

    // 適当なテンポ計算
    var timing = { // 4分音符に24回届くtimingメッセージを元にテンポを推定する
      running: false, // startを受けてtrue, stopを受けてfalse

      starttime: 0, // startを受けた時の時刻
      count:     0, // startからの累積カウント
      tempo:     0,

      onBeat: function(){}, // 四分音符で何するか

      onStart : function(){
        this.running   = true;
        this.starttime = new Date().getTime();
      },

      onStop : function(){
        this.running = false;
        this.count   = 0;
      },

      onTiming : function(){
        if (this.count % 24 == 0) this.onBeat();
        if (this.count > 0){
          var elapsed = new Date().getTime() - this.starttime; // 再生中のテンポ変更はNG
          this.tempo   = 60. * 1000. / ((elapsed / this.count) * 24);
        }
        this.count += 1;
      },

      get : function(obj){
        if(obj.address == "/fm/start")  return this.onStart();
        if(obj.address == "/fm/timing") return this.onTiming();
        if(obj.address == "/fm/stop")   return this.onStop();
      }
    };

    // デバイス名を作る
    function makeNodeName(client){
      var name = client.type
      if (client.type == "json") name += ": socket[" + client.socketId + "]"
      if (client.type == "midi") name += ": " + client.name
      if (client.type == "osc" ) name += ": " + client.host + "(" + client.port + ")"
      return name
    }

    // 接続/切断ボタンを作る
    function makeConnectionButton(isNowConnected, event){
      var btn = document.createElement("input");  /*  inputタグを作成して…  */
      // btn.id = "button1";
      btn.type = "button";
      btn.value = isNowConnected ? "o" : "x";
      btn.addEventListener('click', event);
      return btn;
    }

    // プレーンテキストで接続状態を表示する
    function makeConnectionString(inputs, outputs, connections){
      var txt = "[network and connection information]<br>"
      for (var inputId in inputs){
        txt += "input _" + inputId + ", [" + makeNodeName(inputs[inputId]) + "]<br>"
      }

      for (var outputId in outputs){
        txt += "output_" + outputId + ", [" + makeNodeName(outputs[outputId]) + "]<br>"
      }

      for (var inputId in connections){
        for (var outputId in connection[inputId]){
          txt += "connection from input " + inputId + " => output " + outputId + "<br>"
        }
      }
      return txt;
    }

    // N個のdevice名を記した配列を受け取ってその接続マトリックスのhtmlを作る
    function makeConnectionTable(inputNames, outputNames, connections){
      var table = document.createElement('table');
      // タイトル行
      var tr = table.insertRow(-1)
      tr.insertCell(-1).outputHTML = "";
      for(var outputId in outputNames){
        tr.insertCell(-1).innerHTML = outputNames[outputId];
      }
      table.appendChild(tr);

      // データ行
      console.log("connections: ", JSON.stringify(connections));
      for(var inputId in inputNames){
        var tr = table.insertRow(-1)
        tr.insertCell(-1).innerHTML = inputNames[inputId];
        for(var outputId in outputNames){
          var isConnected = (inputId in connections) && (outputId in connections[inputId]);

          // 「ボタンを押すとコネクションを貼り直すメッセージをサーバーに送信する」関数を作る
          // closureにしてローカル変数をキャプチャする
          var _onclick = function(_inputId, _outputId, connect){
            return function(){
              console.log("add_connection: " + JSON.stringify(   {inputId: _inputId, outputId: _outputId, connect: connect}));
              if(self.socket) self.socket.emit("add_connection", {inputId: _inputId, outputId: _outputId, connect: connect});
            }
          }

          tr.insertCell(-1).appendChild(makeConnectionButton(isConnected, _onclick(inputId, outputId, (! isConnected) )));
        }
      }

      return table;
    }

    // jsonクライアントとして受けとったメッセージを追加する
    function addMessage(obj){
      // console.log(obj.address, view.filter)
      if (! (obj.address in view.filter)){ // filter考慮
        var domMeg = document.createElement('div');
        // domMeg.innerHTML = new Date().toLocaleTimeString() + ' ' + msg;
        domMeg.innerHTML = JSON.stringify(obj);
        document.getElementById("msg").appendChild(domMeg)
      }
    }

    // jsonクライアントの表示/非表示を切り替える
    function showJsonClient(onoff){
      document.getElementById("jsonclient").style.display = (onoff ? "block" : "none");
    }

    // ソケット関係
    self = {
      socket:    undefined,

      start: function(){
        this.socket = io.connect(/*'http://localhost:8080'*/);

        // リスト更新
        this.socket.on("update_list", function (obj) {
          // var inputNames  = obj.inputs.map (function(input ){makeNodeName(input );});
          // var outputNames = obj.outputs.map(function(output){makeNodeName(output);});
          // var inputNames  = Object.keys(obj.inputs ).map(function(key, i) { return {id: key, name: makeNodeName(obj.inputs [key])}; });
          // var outputNames = Object.keys(obj.outputs).map(function(key, i) { return {id: key, name: makeNodeName(obj.outputs[key])}; });
          var inputNames  = {}; for(var inputId  in obj.inputs ) inputNames [inputId ] = makeNodeName(obj.inputs [inputId ]);
          var outputNames = {}; for(var outputId in obj.outputs) outputNames[outputId] = makeNodeName(obj.outputs[outputId]);
          var table = makeConnectionTable(inputNames, outputNames, obj.connections)

          // self.addMessage(txt);
          var networkArea = document.getElementById("network");
          networkArea.textContent = null;
          networkArea.appendChild(table);
        });

        this.socket.on("message_json", function (obj) {
          addMessage(obj);
          timing.get(obj);
        });

        this.socket.on("disconnect", function () {
          showJsonClient(false);
        });

        // this.addMessage("貴方は" + this.myName + "として入室しました");
        // this.socket.emit("connected", {name: this.myName});
      },


      join_as_wsjson: function() {
        this.socket.emit("join_as_wsjson");
        showJsonClient(true);
      },

      join_as_osc: function() {
        var host = document.getElementById('osc_host_input');
        var port = document.getElementById('osc_port_input');
        this.socket.emit("join_as_osc", {host: host.value, port: port.value});
      },

      publishMessage: function() {
        var textInput = document.getElementById('msg_input');
        try{
          var obj = JSON.parse(textInput.value);
          this.socket.emit("message_json", obj);
          document.getElementById("errormsg").innerHTML = "";
        } catch(e){
          document.getElementById("errormsg").innerHTML = "json syntax error";
        }
      },

    }

    // 開始!
    window.onload = function(){
      self.start();
      showJsonClient(false);
      timing.onBeat = function(){
        document.getElementById("tempo").innerHTML = timing.tempo;
      };
    }
  </script>

</head>
<body>
  <h2>接続中のデバイス</h2>
  <div id="network"></div>

  <br>======================================================================<br>
  このページをJSONクライアントとしてネットワーク参加する
  <button onclick="self.join_as_wsjson();">参加</button><br>

  <div id=jsonclient>
    <textarea name="msg_input" id="msg_input", cols="60", rows="8"> </textarea>
    <button onclick="self.publishMessage();">JSONを送る</button>
    <p id=errormsg> </p>
    <div id="msg"></div>

    filter:
    <input type="checkbox" onclick="view.filterSet(this);" value="/fm/noteon">  noteon
    <input type="checkbox" onclick="view.filterSet(this);" value="/fm/noteoff"> noteoff
    <input type="checkbox" onclick="view.filterSet(this);" value="/fm/timing"> timing

    <br>
    tempo: <span id="tempo"> </span>

  </div>

  <br>
  <br>======================================================================<br>
  OSCクライアントをネットワークに登録する<br>
  oscホストアドレス<input  type="text" id="osc_host_input" style="width:80px;" />
  待ち受けポート番号<input type="text" id="osc_port_input" style="width:80px;" />
  <button onclick="self.join_as_osc();">登録</button>

  <br>
</body>
</html>
