<html>
<head>
  <meta charset="UTF-8">
  <title>FM_MW1</title>
  <style type="text/css">
  <!--
  table, td, th {
    border: solid 1px #999999;
  }
  //-->
  </style>

  <script src="/socket.io/socket.io.js"></script>
  <script type="text/javascript">
    "use strict";

    function makeNodeName(client){
      var name = client.type
      if (client.type == "json") name += ": socket[" + client.socketId + "]"
      if (client.type == "midi") name += ": " + client.name
      if (client.type == "osc" ) name += ": " + client.host + "(" + client.port + ")"
      return name
    }

    function makeConnectionButton(isNowConnected, event){
      var btn = document.createElement("input");  /*  inputタグを作成して…  */
      // btn.id = "button1";
      btn.type = "button";
      btn.value = isNowConnected ? "o" : "x";
      btn.addEventListener('click', event);
      return btn;
    }

    // プレーンテキストで接続状態を表示する
    function makeConnectionString(inputs, outputs, connections){
      var txt = "[network and connection information]<br>"
      for (var i in inputs){
        txt += "input _" + i + ", [" + makeNodeName(inputs[i]) + "]<br>"
      }

      for (var o in outputs){
        txt += "output_" + o + ", [" + makeNodeName(outputs[o]) + "]<br>"
      }

      for (var c in connections){
        connection = connections[c]
        for (var d in connection){
          txt += "connection from input " + c + " => output " + d + "<br>"
        }
      }
      return txt;
    }

    // N個のdevice名を記した配列を受け取ってその接続マトリックスのhtmlを作る
    function makeConnectionTable(inputNames, outputNames, connections){
      var table = document.createElement('table');
      // タイトル行
      var tr = table.insertRow(-1)
      tr.insertCell(-1).outputHTML = "";
      for(var o=0; o<outputNames.length; ++o){
        tr.insertCell(-1).innerHTML = outputNames[o].name;
      }
      table.appendChild(tr);

      // データ行
      console.log("connections: ", JSON.stringify(connections));
      for(var i=0; i<inputNames.length; ++i){
        var tr = table.insertRow(-1)
        tr.insertCell(-1).innerHTML = inputNames[i].name;
        for(var o=0; o<outputNames.length; ++o){
          var isConnected = (inputNames[i].id in connections) && (connections[inputNames[i].id].indexOf(outputNames[o].id) >= 0);
          // console.log(inputNames[i].id, ":", outputNames[o].id, ":", connections[inputNames[i].id], ":", isConnected);
          var _onclick = function(_i, _o, connect){
            return function(){
              // ボタンを押すとコネクションを貼り直すメッセージをサーバーに送信
              console.log("add_connection: " + JSON.stringify({inputId: inputNames[_i].id, outputId: outputNames[_o].id, connect: connect}));
              if(self.socket) self.socket.emit("add_connection", {inputId: inputNames[_i].id, outputId: outputNames[_o].id, connect: connect});
            }
          }

          tr.insertCell(-1).appendChild(makeConnectionButton(isConnected, _onclick(i, o, (! isConnected) )));
        }
      }

      return table;
    }

    self = {
      socket:    undefined,

      myName:      Math.floor(Math.random()*100) + "さん",
      // textInput:   ,
      // msgArea:     ,
      // networkArea: ,


      start: function(){
        this.socket = io.connect(/*'http://localhost:8080'*/);

        // リスト更新
        this.socket.on("update_list", function (obj) {
          // var inputNames  = obj.inputs.map (function(input ){makeNodeName(input );});
          // var outputNames = obj.outputs.map(function(output){makeNodeName(output);});
          var inputNames  = Object.keys(obj.inputs ).map(function(key, i) { return {id: key, name: makeNodeName(obj.inputs [key])}; });
          var outputNames = Object.keys(obj.outputs).map(function(key, i) { return {id: key, name: makeNodeName(obj.outputs[key])}; });
          var table = makeConnectionTable(inputNames, outputNames, obj.connections)

          // self.addMessage(txt);
          var networkArea = document.getElementById("network");
          networkArea.textContent = null;
          networkArea.appendChild(table);
        });

        this.socket.on("message_json", function (obj) {
          self.addMessage(JSON.stringify(obj));
        });

        this.socket.on("disconnect", function () {
          // noop
        });

        // this.addMessage("貴方は" + this.myName + "として入室しました");
        // this.socket.emit("connected", {name: this.myName});
      },


      join_as_wsjson: function() {
        this.socket.emit("join_as_wsjson");
      },

      join_as_osc: function() {
        var host = document.getElementById('osc_host_input');
        var port = document.getElementById('osc_port_input');
        this.socket.emit("join_as_osc", {host: host.value, port: port.value});
      },

      publishMessage: function() {
        var textInput = document.getElementById('msg_input');
        var msg = textInput.value;
        this.socket.emit("message_json", msg);
        // this.textInput.value = '';
      },

      addMessage: function(msg){
        var domMeg = document.createElement('div');
        // domMeg.innerHTML = new Date().toLocaleTimeString() + ' ' + msg;
        domMeg.innerHTML = msg;
        var msgArea = document.getElementById("msg")
        msgArea.appendChild(domMeg);
      },
    }

    self.start();
  </script>

</head>
<body>
  このページをJSONクライアントとしてネットワーク参加する
  <button onclick="self.join_as_wsjson();">参加</button><br>
  <textarea name="msg_input" id="msg_input", cols="60", rows="8"> </textarea>
  <button onclick="self.publishMessage();">JSONを送る</button>
  <div id="msg"></div>

  <br>
  <br>======================================================================<br>
  OSCクライアントをネットワークに登録する<br>
  oscホストアドレス<input  type="text" id="osc_host_input" style="width:80px;" />
  待ち受けポート番号<input type="text" id="osc_port_input" style="width:80px;" />
  <button onclick="self.join_as_osc();">登録</button>


  <br>
  <br>======================================================================<br>
  <div id="network"></div>
</body>
</html>
